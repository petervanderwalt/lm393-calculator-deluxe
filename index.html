<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM393 Universal Simulator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }

    #app-container {
        flex: 1 1 auto;
        display: flex;
        flex-direction: row;
        min-height: 0;
    }

    #main-content {
        flex: 1 1 auto;
        padding: 1.5rem;
        overflow-y: auto;
    }

    #sidebar {
        flex: 0 0 360px; /* Widened sidebar */
        padding: 1.5rem;
        background-color: #e9ecef;
        overflow-y: auto;
        border-left: 1px solid #dee2e6;
    }

    #sidebar h6 {
        font-weight: bold;
        color: #495057;
        margin-top: .5rem;
    }

    #schematic-container {
        background-color: #FFFFFF;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 450px;
    }

    #schematic-container svg {
        stroke: #333; stroke-width: 2; fill: none;
        font-family: 'Courier New', Courier, monospace;
        font-size: 14px;
        width: 100%;
        max-width: 600px;
        height: auto;
    }
    #schematic-container svg text { fill: #000; stroke: none; text-anchor: middle;}
    #schematic-container svg .label { font-weight: bold; }

    .led {
        width: 30px; height: 30px; background-color: #333;
        border-radius: 50%; border: 2px solid #555;
        transition: background-color 0.2s, box-shadow 0.2s;
        display: inline-block;
    }
    .led.on {
        background-color: #198754;
        box-shadow: 0 0 15px #198754;
    }
    .nav-link { cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark p-2">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">LM393 Universal Simulator</a>
        </div>
    </nav>

    <div id="app-container">
        <!-- Main Content for Results and Schematic -->
        <div id="main-content">
            <h3>Calculated Results</h3>
             <div class="card p-3 mb-4">
                <div id="results-resistance">
                    <div class="row"><div class="col-md-6"><h5>Feedback Resistor (Rf):</h5><p class="fs-5 fw-bold" id="result_rf_res">-- kΩ</p></div><div class="col-md-6"><h5>Required Pull-up (Rp):</h5><p class="fs-5 fw-bold">~10 kΩ</p></div></div>
                </div>
                <div id="results-voltage" class="d-none">
                    <div class="row"><div class="col-sm-4"><h5>VRef Resistor R1:</h5><p class="fs-5 fw-bold" id="result_r1">-- kΩ</p></div><div class="col-sm-4"><h5>VRef Resistor R2:</h5><p class="fs-5 fw-bold">10.00 kΩ</p></div><div class="col-sm-4"><h5>Feedback Resistor (Rf):</h5><p class="fs-5 fw-bold" id="result_rf_volt">-- kΩ</p></div></div>
                </div>
            </div>

            <h3 class="mt-4">Schematic</h3>
             <div id="schematic-container">
                <!-- External SVGs will be loaded here -->
             </div>
        </div>

        <!-- Sidebar for Controls and Simulation -->
        <div id="sidebar">
            <h6>1. Input Mode</h6>
            <ul class="nav nav-tabs nav-fill" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" id="resistance-tab" data-bs-toggle="tab" type="button">Resistance</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="voltage-tab" data-bs-toggle="tab" type="button">Voltage</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" id="current-tab" data-bs-toggle="tab" type="button">Current</button></li>
            </ul>

            <div class="tab-content pt-3" id="configTabContent">
                <div class="mb-3"><label for="vcc" class="form-label">Supply Voltage (VCC)</label><input type="number" class="form-control" id="vcc" value="5"></div>
                <div id="resistance-pane">
                    <div class="mb-3"><label for="vref_res" class="form-label">Reference Voltage (VRef)</label><input type="number" class="form-control" id="vref_res" step="0.1" value="2.5"></div>
                    <div class="mb-3"><label for="r_fixed" class="form-label">Fixed Resistor (R_fixed) from VCC (in Ohms)</label><input type="number" class="form-control" id="r_fixed" value="3900"></div>
                </div>
                <div id="voltage-pane" class="d-none"><p class="text-muted small">VRef will be centered automatically. R1/R2 calculated assuming R2=10kΩ.</p></div>
                <div id="current-pane" class="d-none">
                     <div class="mb-3"><label for="r_shunt" class="form-label">Shunt Resistor (in Ohms)</label><input type="number" class="form-control" id="r_shunt" value="120"></div>
                     <p class="text-muted small">VRef will be centered automatically, and R1/R2 calculated.</p>
                </div>
            </div>
            <hr class="my-2">
            <h6>2. Hysteresis Requirements</h6>
            <div id="hysteresis-resistance">
                <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF Ohms)</label><input type="number" class="form-control" id="r_low_trip" value="2500"></div>
                <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON Ohms)</label><input type="number" class="form-control" id="r_high_trip" value="5500"></div>
            </div>
            <div id="hysteresis-voltage" class="d-none">
                <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF Volts)</label><input type="number" class="form-control" id="v_low_trip" value="2.43"></div>
                <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON Volts)</label><input type="number" class="form-control" id="v_high_trip" value="2.71"></div>
            </div>
            <div id="hysteresis-current" class="d-none">
                <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF mA)</label><input type="number" class="form-control" id="c_low_trip" value="10"></div>
                <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON mA)</label><input type="number" class="form-control" id="c_high_trip" value="15"></div>
            </div>
            <hr class="my-3">
            <h6>3. Live Simulation</h6>
            <div class="mb-3">
                <label for="sim_slider" class="form-label" id="slider_label">Sensor Value</label>
                <input type="range" class="form-range" id="sim_slider" min="0" max="10000" step="10">
            </div>
            <div class="d-flex justify-content-between">
                <span id="v_low_text">V_LT: -- V</span>
                <span class="fw-bold" id="slider_native_value">--</span>
                <span id="v_high_text">V_UT: -- V</span>
            </div>
            <div class="text-center mt-2">
                <span class="fw-bold" id="v_sim_text">V_Sense: -- V</span>
            </div>
            <hr class="my-2">
            <div class="text-center">
                <h6>Comparator Output State</h6>
                <div id="output_led" class="led mx-auto mt-2"></div>
                <p class="mt-2 fw-bold fs-5" id="output_state_text">HIGH (Floating)</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let currentMode = 'resistance';
        let isOutputActive = false;
        let v_ut = 0, v_lt = 0;

        const allInputs = document.querySelectorAll('.form-control');
        const tabs = document.querySelectorAll('#configTabs .nav-link');
        const simSlider = document.getElementById('sim_slider');
        const schematicContainer = document.getElementById('schematic-container');

        const uiPanes = {
            resistance: [document.getElementById('resistance-pane'), document.getElementById('hysteresis-resistance'), document.getElementById('results-resistance')],
            voltage: [document.getElementById('voltage-pane'), document.getElementById('hysteresis-voltage'), document.getElementById('results-voltage')],
            current: [document.getElementById('current-pane'), document.getElementById('hysteresis-current'), document.getElementById('results-voltage')]
        };

        function calculateFromVoltages(VCC, V_UT, V_LT) {
            const V_HYS = V_UT - V_LT;
            if (V_HYS <= 0 || V_UT > VCC) return { R1: NaN, R2: 10000, Rf: NaN, VRef: NaN };
            const VRef = (V_UT + V_LT) / 2;
            const R2 = 10000;
            const R1 = (VCC * R2 / VRef) - R2;
            const Rf = (VCC * (R1 * R2) / (R1 + R2)) / V_HYS;
            return { R1, R2, Rf, VRef };
        }

        function calculate() {
            const VCC = parseFloat(document.getElementById('vcc').value);
            let results = {};
            if (currentMode === 'resistance') {
                const VREF = parseFloat(document.getElementById('vref_res').value);
                const R_FIXED = parseFloat(document.getElementById('r_fixed').value);
                const R_LOW_TRIP = parseFloat(document.getElementById('r_low_trip').value);
                const R_HIGH_TRIP = parseFloat(document.getElementById('r_high_trip').value);
                v_ut = VCC * (R_HIGH_TRIP / (R_FIXED + R_HIGH_TRIP));
                v_lt = VCC * (R_LOW_TRIP / (R_FIXED + R_LOW_TRIP));
                const R_EQ_LOW = (VREF * R_FIXED) / (VCC - VREF);
                const Rf_for_high = (R_EQ_LOW * R_HIGH_TRIP) / (R_HIGH_TRIP - R_EQ_LOW);
                const R_EQ_HIGH = (VCC * R_LOW_TRIP - VREF * R_LOW_TRIP) / VREF;
                const Rf_for_low = (R_EQ_HIGH * R_FIXED) / (R_FIXED - R_EQ_HIGH);
                results.Rf = (Rf_for_high + Rf_for_low) / 2;
                results.VRef = VREF;
            } else if (currentMode === 'voltage') {
                v_ut = parseFloat(document.getElementById('v_high_trip').value);
                v_lt = parseFloat(document.getElementById('v_low_trip').value);
                results = calculateFromVoltages(VCC, v_ut, v_lt);
            } else if (currentMode === 'current') {
                const R_SHUNT = parseFloat(document.getElementById('r_shunt').value);
                const C_HIGH_TRIP_A = parseFloat(document.getElementById('c_high_trip').value) / 1000;
                const C_LOW_TRIP_A = parseFloat(document.getElementById('c_low_trip').value) / 1000;
                v_ut = C_HIGH_TRIP_A * R_SHUNT;
                v_lt = C_LOW_TRIP_A * R_SHUNT;
                results = calculateFromVoltages(VCC, v_ut, v_lt);
            }
            updateUI(results);
        }

        function updateUI(results) {
            if (currentMode === 'resistance') {
                document.getElementById('result_rf_res').textContent = `${(results.Rf / 1000).toFixed(2)} kΩ`;
            } else {
                document.getElementById('result_r1').textContent = isNaN(results.R1) ? 'N/A' : `${(results.R1 / 1000).toFixed(2)} kΩ`;
                document.getElementById('result_rf_volt').textContent = isNaN(results.Rf) ? 'N/A' : `${(results.Rf / 1000).toFixed(2)} kΩ`;
            }
            document.getElementById('v_high_text').textContent = `V_UT: ${v_ut.toFixed(2)} V`;
            document.getElementById('v_low_text').textContent = `V_LT: ${v_lt.toFixed(2)} V`;
            updateSchematic(results);
            simulate();
        }

        function simulate() {
            const VCC = parseFloat(document.getElementById('vcc').value);
            const sliderVal = parseFloat(simSlider.value);
            let v_sense = 0;
            let native_text = '';
            if (currentMode === 'resistance') {
                const R_FIXED = parseFloat(document.getElementById('r_fixed').value);
                v_sense = VCC * (sliderVal / (R_FIXED + sliderVal));
                native_text = `${(sliderVal / 1000).toFixed(2)} kΩ`;
            } else if (currentMode === 'voltage') {
                v_sense = sliderVal;
                native_text = `${sliderVal.toFixed(2)} V`;
            } else if (currentMode === 'current') {
                const R_SHUNT = parseFloat(document.getElementById('r_shunt').value);
                v_sense = (sliderVal / 1000) * R_SHUNT;
                native_text = `${sliderVal.toFixed(1)} mA`;
            }
            document.getElementById('v_sim_text').textContent = `V_Sense: ${v_sense.toFixed(2)} V`;
            document.getElementById('slider_native_value').textContent = native_text;
            if (isOutputActive && v_sense < v_lt) isOutputActive = false;
            else if (!isOutputActive && v_sense > v_ut) isOutputActive = true;
            const led = document.getElementById('output_led');
            const stateText = document.getElementById('output_state_text');
            if (isOutputActive) {
                led.classList.add('on');
                stateText.textContent = 'LOW (Active)';
            } else {
                led.classList.remove('on');
                stateText.textContent = 'HIGH (Floating)';
            }
        }

        function updateSchematic(r) {
            if (schematicContainer.querySelector('svg') === null) return; // Don't run if SVG not loaded yet

            if (currentMode === 'resistance') {
                document.getElementById('r-fixed-value-res').textContent = `${(parseFloat(document.getElementById('r_fixed').value) / 1000).toFixed(2)}k`;
                document.getElementById('rf-value-res').textContent = `${(r.Rf / 1000).toFixed(2)}k`;
                document.getElementById('vref-text-res').textContent = `${r.VRef.toFixed(2)}V`;
            } else {
                document.getElementById('r1-value-vc').textContent = isNaN(r.R1) ? 'N/A' : `${(r.R1 / 1000).toFixed(2)}k`;
                document.getElementById('r2-value-vc').textContent = '10.0k';
                document.getElementById('rf-value-vc').textContent = isNaN(r.Rf) ? 'N/A' : `${(r.Rf / 1000).toFixed(2)}k`;
                document.getElementById('vref-text-vc').textContent = isNaN(r.VRef) ? 'VRef' : `VRef (${r.VRef.toFixed(2)}V)`;
                const label = document.getElementById('vsense-label-vc');
                if (currentMode === 'voltage') {
                    label.textContent = 'V_Sensor';
                } else {
                    const shunt = document.getElementById('r_shunt').value;
                    label.textContent = `I_Sensor -> R_Shunt(${shunt}Ω)`;
                }
            }
        }

        async function switchMode(newMode) {
            currentMode = newMode;
            Object.values(uiPanes).flat().forEach(el => el.classList.add('d-none'));
            uiPanes[newMode].forEach(el => el.classList.remove('d-none'));

            // Fetch and load the correct SVG
            try {
                const response = await fetch(`${newMode}.svg`);
                if (!response.ok) throw new Error('Network response was not ok');
                const svgText = await response.text();
                schematicContainer.innerHTML = svgText;
            } catch (error) {
                schematicContainer.innerHTML = `<p class="text-danger">Error loading schematic: ${error.message}</p><p>Please ensure ${newMode}.svg is in the same folder as this HTML file.</p>`;
                return;
            }

            const sliderLabel = document.getElementById('slider_label');
            const VCC = parseFloat(document.getElementById('vcc').value);
            if (newMode === 'resistance') {
                sliderLabel.textContent = 'Sensor Resistance';
                simSlider.min = 0; simSlider.max = 10000; simSlider.step = 10; simSlider.value = 4000;
            } else if (newMode === 'voltage') {
                sliderLabel.textContent = 'Sensor Voltage';
                simSlider.min = 0; simSlider.max = VCC; simSlider.step = 0.01; simSlider.value = VCC / 2;
            } else if (newMode === 'current') {
                sliderLabel.textContent = 'Sensor Current';
                simSlider.min = 0; simSlider.max = 25; simSlider.step = 0.1; simSlider.value = 12;
            }
            // Recalculate to populate the new schematic with initial values
            calculate();
        }

        tabs.forEach(tab => tab.addEventListener('shown.bs.tab', (event) => switchMode(event.target.id.split('-')[0])));
        allInputs.forEach(input => input.addEventListener('input', calculate));
        simSlider.addEventListener('input', simulate);
        window.addEventListener('load', () => switchMode('resistance'));
    </script>
</body>
</html>
