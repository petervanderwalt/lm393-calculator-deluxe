<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM393 Calculator (Voltage, Resistance, Current, Hysteresis)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    html, body {
      height: 100%; margin: 0; overflow: hidden;
    }
    body {
      display: flex; flex-direction: column; background-color: #f8f9fa;
    }
    #app-container {
        flex: 1 1 auto; display: flex; flex-direction: row; min-height: 0;
    }
    #main-content {
        flex: 1 1 auto; padding: 1.5rem; overflow-y: auto;
    }
    #sidebar {
        flex: 0 0 360px; padding: 1.5rem; background-color: #e9ecef;
        overflow-y: auto; border-left: 1px solid #dee2e6;
    }
    #sidebar h6 {
        font-weight: bold; color: #495057; margin-top: .5rem;
    }
    #schematic-container {
        align-items: center;
    }
    #schematic-container svg {
        width: 100%; max-width: 550px; height: auto;
    }
    .led {
        width: 30px; height: 30px; background-color: #333;
        border-radius: 50%; border: 2px solid #555;
        transition: background-color 0.2s, box-shadow 0.2s; display: inline-block;
    }
    .led.off {
        background-color: #198754; box-shadow: 0 0 15px #198754;
    }

    .led.on {
        background-color: #dc3545; box-shadow: 0 0 15px #dc3545;
    }

    .form-range::-webkit-slider-runnable-track {
         background-color: #888;
         /* Add other styles as needed */
     }

     .form-range::-moz-range-track {
         background-color: #888;
         /* Add other styles as needed */
     }

    .nav-link { cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark p-2">
        <div class="container-fluid"><a class="navbar-brand" href="#">LM393 Calculator</a></div>
    </nav>

    <div id="app-container">

      <!-- Sidebar for Controls and Simulation -->
      <div id="sidebar">
          <h6>1. Input Mode</h6>
          <ul class="nav nav-pills nav-fill" id="configTabs" role="tablist">
              <li class="nav-item" role="presentation"><button class="nav-link active" id="resistance-tab" data-bs-toggle="tab" type="button">Resistance</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="voltage-tab" data-bs-toggle="tab" type="button">Voltage</button></li>
              <li class="nav-item" role="presentation"><button class="nav-link" id="current-tab" data-bs-toggle="tab" type="button">Current</button></li>
          </ul>

          <div class="tab-content pt-3" id="configTabContent">
              <div class="mb-3"><label for="vcc" class="form-label">Supply Voltage (VCC)</label><input type="number" class="form-control" id="vcc" value="5"></div>
              <div id="resistance-pane">
                  <div class="mb-3"><label for="r_fixed" class="form-label">Fixed Resistor (R1) (in Ohms)</label><input type="number" class="form-control" id="r_fixed" value="3900"></div>
              </div>
              <div id="voltage-pane" class="d-none"></div>
              <div id="current-pane" class="d-none">
                   <div class="mb-3"><label for="r_shunt" class="form-label">Shunt Resistor (in Ohms)</label><input type="number" class="form-control" id="r_shunt" value="120"></div>
              </div>
          </div>
          <hr class="my-2">
          <h6>2. Threshold Requirements</h6>
          <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" role="switch" id="enable_hysteresis" checked>
              <label class="form-check-label" for="enable_hysteresis">Enable Hysteresis</label>
          </div>

          <div id="hysteresis_inputs">
              <div id="hysteresis-resistance">
                  <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF Ohms)</label><input type="number" class="form-control" id="r_low_trip" value="2500"></div>
                  <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON Ohms)</label><input type="number" class="form-control" id="r_high_trip" value="5500"></div>
              </div>
              <div id="hysteresis-voltage" class="d-none">
                  <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF Volts)</label><input type="number" class="form-control" id="v_low_trip" value="2.43"></div>
                  <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON Volts)</label><input type="number" class="form-control" id="v_high_trip" value="2.71"></div>
              </div>
              <div id="hysteresis-current" class="d-none">
                  <div class="mb-2"><label class="form-label">Lower Threshold (Turn-OFF mA)</label><input type="number" class="form-control" id="c_low_trip" value="10"></div>
                  <div class="mb-2"><label class="form-label">Upper Threshold (Turn-ON mA)</label><input type="number" class="form-control" id="c_high_trip" value="15"></div>
              </div>
          </div>

          <div id="single_trip_inputs" class="d-none">
               <div id="single-resistance-pane">
                  <div class="mb-2"><label class="form-label">Threshold (Turn-ON Ohms)</label><input type="number" class="form-control" id="r_trip" value="4500"></div>
              </div>
              <div id="single-voltage-pane" class="d-none">
                  <div class="mb-2"><label class="form-label">Threshold (Turn-ON Volts)</label><input type="number" class="form-control" id="v_trip" value="2.5"></div>
              </div>
              <div id="single-current-pane" class="d-none">
                  <div class="mb-2"><label class="form-label">Threshold (Turn-ON mA)</label><input type="number" class="form-control" id="c_trip" value="12"></div>
              </div>
          </div>
      </div>

        <div id="main-content">
            <div class="card p-3 mb-4">
                <div id="results-resistance">
                     <div class="row">
                        <div class="col-sm-4">
                            <h5>VRef Resistor (Rt):</h5><p class="fs-5 fw-bold" id="result_r1_res">-- kΩ</p>
                        </div>
                        <div class="col-sm-4">
                            <h5>VRef Resistor (Rb):</h5><p class="fs-5 fw-bold" id="result_r2_res">10.00 kΩ</p>
                        </div>
                        <div class="col-sm-4" id="result_rf_res_container">
                            <h5>Feedback Resistor (Rf):</h5><p class="fs-5 fw-bold" id="result_rf_res">-- kΩ</p>
                        </div>
                    </div>
                </div>
                <div id="results-voltage" class="d-none">
                    <div class="row">
                        <div class="col-sm-4">
                            <h5>VRef Resistor (Rt):</h5><p class="fs-5 fw-bold" id="result_r1_volt">-- kΩ</p>
                        </div>
                        <div class="col-sm-4">
                            <h5>VRef Resistor (Rb):</h5><p class="fs-5 fw-bold">10.00 kΩ</p>
                        </div>
                        <div class="col-sm-4" id="result_rf_volt_container">
                            <h5>Feedback Resistor (Rf):</h5><p class="fs-5 fw-bold" id="result_rf_volt">-- kΩ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="schematic-container"  class="card p-3 mb-4"></div>

            <div class="card p-3 mb-4">
              <div class="row">
                <div class="col-md-8">
                  <div class="mb-3">
                      <label for="sim_slider" class="form-label" id="slider_label">Sensor Value</label>
                      <input type="range" class="form-range" id="sim_slider" min="0" max="10000" step="10">
                  </div>
                  <div class="d-flex justify-content-between">
                      <span id="v_low_text">V_LT: -- V</span>
                      <span class="fw-bold" id="slider_native_value">--</span>
                      <span id="v_high_text">V_UT: -- V</span>
                  </div>
                  <div class="text-center mt-2"><span class="fw-bold" id="v_sim_text">V_Sense: -- V</span></div>
                </div>
                <div class="col-md-4">
                  <div class="text-center">
                      <h6>Comparator Output State</h6>
                      <div id="output_led" class="led mx-auto mt-2"></div>
                      <p class="mt-2 fw-bold fs-5" id="output_state_text">HIGH (Floating)</p>
                  </div>
                </div>
              </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentMode = 'resistance';
        let isOutputActive = false;
        let v_ut = 0, v_lt = 0;

        const e96Multipliers = [
            100, 102, 105, 107, 110, 113, 115, 118, 121, 124, 127, 130, 133, 137, 140, 143, 147, 150, 154, 158, 162, 165, 169, 174, 178, 182, 187, 191, 196, 200, 205, 210, 215, 221, 226, 232, 237, 243, 249, 255, 261, 267, 274, 280, 287, 294, 301, 309, 316, 324, 332, 340, 348, 357, 365, 374, 383, 392, 402, 412, 422, 432, 442, 453, 464, 475, 487, 499, 511, 523, 536, 549, 562, 576, 590, 604, 619, 634, 649, 665, 681, 698, 715, 732, 750, 768, 787, 806, 825, 845, 866, 887, 909, 931, 953, 976
        ];

        function findClosestE96(idealValue) {
            if (isNaN(idealValue) || idealValue <= 0) return NaN;
            const magnitude = Math.pow(10, Math.floor(Math.log10(idealValue)));
            const normalizedValue = idealValue / magnitude * 100;
            const closestMultiplier = e96Multipliers.reduce((a, b) => Math.abs(b - normalizedValue) < Math.abs(a - normalizedValue) ? b : a);
            return (closestMultiplier / 100) * magnitude;
        }

        const allInputs = document.querySelectorAll('.form-control');
        const tabs = document.querySelectorAll('#configTabs .nav-link');
        const simSlider = document.getElementById('sim_slider');
        const schematicContainer = document.getElementById('schematic-container');
        const hysteresisToggle = document.getElementById('enable_hysteresis');

        function calculateFromVoltages(VCC, V_UT_target, V_LT_target) {
            const V_HYS_target = V_UT_target - V_LT_target;
            if (V_HYS_target <= 0 || V_UT_target > VCC) return { R1: NaN, R2: 10000, Rf: NaN, V_UT_actual: V_UT_target, V_LT_actual: V_LT_target };
            const VRef_target = (V_UT_target + V_LT_target) / 2;
            const R2_standard = 10000;
            const R1_ideal = (VCC * R2_standard / VRef_target) - R2_standard;
            const R_divider_ideal = (R1_ideal * R2_standard) / (R1_ideal + R2_standard);
            const Rf_ideal = (VCC * R_divider_ideal) / V_HYS_target;
            const R1_standard = findClosestE96(R1_ideal);
            const Rf_standard = findClosestE96(Rf_ideal);
            const VRef_actual = VCC * R2_standard / (R1_standard + R2_standard);
            const R_divider_actual = (R1_standard * R2_standard) / (R1_standard + R2_standard);
            const V_HYS_actual = VCC * R_divider_actual / Rf_standard;
            return { R1: R1_standard, R2: R2_standard, Rf: Rf_standard, V_UT_actual: VRef_actual + V_HYS_actual / 2, V_LT_actual: VRef_actual - V_HYS_actual / 2 };
        }

        function calculate() {
            const VCC = parseFloat(document.getElementById('vcc').value);
            const isHysteresisEnabled = hysteresisToggle.checked;
            let results = {};

            document.getElementById('result_rf_res_container').classList.toggle('d-none', !isHysteresisEnabled);
            document.getElementById('result_rf_volt_container').classList.toggle('d-none', !isHysteresisEnabled);

            if (isHysteresisEnabled) {
                 if (currentMode === 'resistance') {
                    const VREF = VCC / 2;
                    const R_FIXED = parseFloat(document.getElementById('r_fixed').value);
                    const R_LOW_TRIP = parseFloat(document.getElementById('r_low_trip').value);
                    const R_HIGH_TRIP = parseFloat(document.getElementById('r_high_trip').value);
                    v_ut = VCC * (R_HIGH_TRIP / (R_FIXED + R_HIGH_TRIP));
                    v_lt = VCC * (R_LOW_TRIP / (R_FIXED + R_LOW_TRIP));
                    const R_EQ_LOW = (VREF * R_FIXED) / (VCC - VREF);
                    const Rf_for_high = (R_EQ_LOW * R_HIGH_TRIP) / (R_HIGH_TRIP - R_EQ_LOW);
                    const R_EQ_HIGH = (VCC * R_LOW_TRIP - VREF * R_LOW_TRIP) / VREF;
                    const Rf_for_low = (R_EQ_HIGH * R_FIXED) / (R_FIXED - R_EQ_HIGH);
                    results.Rf = findClosestE96((Rf_for_high + Rf_for_low) / 2);
                    results.R1 = 10000;
                } else {
                    let v_ut_target, v_lt_target;
                    if (currentMode === 'voltage') {
                        v_ut_target = parseFloat(document.getElementById('v_high_trip').value);
                        v_lt_target = parseFloat(document.getElementById('v_low_trip').value);
                    } else { // current
                        const R_SHUNT = parseFloat(document.getElementById('r_shunt').value);
                        v_ut_target = (parseFloat(document.getElementById('c_high_trip').value) / 1000) * R_SHUNT;
                        v_lt_target = (parseFloat(document.getElementById('c_low_trip').value) / 1000) * R_SHUNT;
                    }
                    results = calculateFromVoltages(VCC, v_ut_target, v_lt_target);
                    v_ut = results.V_UT_actual;
                    v_lt = results.V_LT_actual;
                }
            } else { // Hysteresis is DISABLED
                results.Rf = NaN;
                let v_trip_target;
                if (currentMode === 'resistance') {
                    const R_FIXED = parseFloat(document.getElementById('r_fixed').value);
                    const R_TRIP = parseFloat(document.getElementById('r_trip').value);
                    v_trip_target = VCC * (R_TRIP / (R_FIXED + R_TRIP));
                } else if (currentMode === 'voltage') {
                    v_trip_target = parseFloat(document.getElementById('v_trip').value);
                } else { // current
                    const R_SHUNT = parseFloat(document.getElementById('r_shunt').value);
                    v_trip_target = (parseFloat(document.getElementById('c_trip').value) / 1000) * R_SHUNT;
                }

                if (v_trip_target > VCC || v_trip_target <= 0) {
                    results.R1 = NaN;
                    v_ut = v_lt = v_trip_target;
                } else {
                    const R2_standard = 10000;
                    const R1_ideal = (VCC * R2_standard / v_trip_target) - R2_standard;
                    results.R1 = findClosestE96(R1_ideal);
                    v_ut = v_lt = VCC * R2_standard / (results.R1 + R2_standard);
                }
            }

            // --- DYNAMIC SLIDER UPDATE (THE FIX) ---
            if (currentMode === 'current') {
                let upper_threshold_mA = parseFloat(isHysteresisEnabled ? document.getElementById('c_high_trip').value : document.getElementById('c_trip').value);
                if (isNaN(upper_threshold_mA) || upper_threshold_mA <= 0) {
                    upper_threshold_mA = 25; // Sensible default if input is invalid
                }
                const new_max = Math.ceil(upper_threshold_mA * 1.5);
                simSlider.max = new_max > 30 ? new_max : 30; // Ensure a minimum range of 30mA

                if (simSlider.max > 1000) simSlider.step = 10;
                else if (simSlider.max > 100) simSlider.step = 1;
                else simSlider.step = 0.1;
            }

            updateUI(results);
        }

        function formatResistorValue(value) {
            if (isNaN(value) || value <= 0) return 'N/A';
            if (value >= 1000) return `${(value / 1000).toFixed(2)} kΩ`;
            return `${value.toFixed(1)} Ω`;
        }

        function updateUI(results) {
            document.getElementById('result_r1_res').innerHTML = formatResistorValue(results.R1);
            document.getElementById('result_rf_res').innerHTML = formatResistorValue(results.Rf);
            document.getElementById('result_r1_volt').innerHTML = formatResistorValue(results.R1);
            document.getElementById('result_rf_volt').innerHTML = formatResistorValue(results.Rf);
            document.getElementById('v_high_text').textContent = `V_UT: ${v_ut.toFixed(3)} V`;
            document.getElementById('v_low_text').textContent = hysteresisToggle.checked ? `V_LT: ${v_lt.toFixed(3)} V` : `Trip Point`;
            updateSchematic(results);
            simulate();
        }

        function simulate() {
            const VCC = parseFloat(document.getElementById('vcc').value);
            const sliderVal = parseFloat(simSlider.value);
            let v_sense = 0;
            let native_text = '';

            if (currentMode === 'resistance') {
                const R_FIXED = parseFloat(document.getElementById('r_fixed').value);
                v_sense = VCC * (sliderVal / (R_FIXED + sliderVal));
                native_text = `${(sliderVal / 1000).toFixed(2)} kΩ`;
            } else if (currentMode === 'voltage') {
                v_sense = sliderVal;
                native_text = `${sliderVal.toFixed(2)} V`;
            } else { // current
                const R_SHUNT = parseFloat(document.getElementById('r_shunt').value);
                v_sense = (sliderVal / 1000) * R_SHUNT;
                native_text = `${sliderVal.toFixed(1)} mA`;
            }

            document.getElementById('v_sim_text').textContent = `V_Sense: ${v_sense.toFixed(3)} V`;
            document.getElementById('slider_native_value').textContent = native_text;

            if (hysteresisToggle.checked) {
                if (isOutputActive && v_sense < v_lt) isOutputActive = false;
                else if (!isOutputActive && v_sense > v_ut) isOutputActive = true;
            } else {
                isOutputActive = v_sense > v_ut;
            }

            const led = document.getElementById('output_led');
            const stateText = document.getElementById('output_state_text');
            if (isOutputActive) {
                led.classList.remove('off'); led.classList.add('on');
                stateText.textContent = 'LOW (Active)';
            } else {
                led.classList.remove('on'); led.classList.add('off');
                stateText.textContent = 'HIGH (Floating)';
            }
        }

        function formatSchematicValue(value) {
            if (isNaN(value) || value <= 0) return '--k';
            if (value >= 1000) return `${(value / 1000).toFixed(2)}k`;
            return `${value.toFixed(1)}Ω`;
        }

        function updateSchematic(r) {
            const svg = schematicContainer.querySelector('svg');
            if (!svg) return;

            const r1Group = svg.querySelector('#R1_GROUP');
            const r2Group = svg.querySelector('#R2_GROUP');
            const inputLabel = svg.querySelector('#INPUT_LABEL');
            const hystGroup = svg.querySelector('#HYST_GROUP');

            hystGroup.style.display = hysteresisToggle.checked ? 'block' : 'none';
            svg.querySelector('#RFVAL tspan').textContent = formatSchematicValue(r.Rf);
            svg.querySelector('#RPVAL tspan').textContent = `10.0k`;

            if (currentMode === 'resistance') {
                r1Group.style.display = 'block';
                r2Group.style.display = 'block';
                inputLabel.style.display = 'none';
                svg.querySelector('#R1VAL tspan').textContent = formatSchematicValue(parseFloat(document.getElementById('r_fixed').value));
                svg.querySelector('#R2VAL tspan').textContent = 'Sensor';
                svg.querySelector('#RTVAL tspan').textContent = formatSchematicValue(r.R1);
                svg.querySelector('#RBVAL tspan').textContent = '10.0k';
            } else {
                r1Group.style.display = 'none';
                r2Group.style.display = currentMode === 'current' ? 'block' : 'none';
                inputLabel.style.display = 'block';
                if (currentMode === 'current') {
                    svg.querySelector('#R2VAL tspan').textContent = `${parseFloat(document.getElementById('r_shunt').value)}Ω Shunt`;
                }
                svg.querySelector('#RTVAL tspan').textContent = formatSchematicValue(r.R1);
                svg.querySelector('#RBVAL tspan').textContent = '10.0k';
            }
        }

        async function switchMode(newMode) {
            currentMode = newMode;

            const allModes = ['resistance', 'voltage', 'current'];
            allModes.forEach(mode => {
                const isCurrent = (mode === newMode);
                document.getElementById(`${mode}-pane`).classList.toggle('d-none', !isCurrent);
                document.getElementById(`hysteresis-${mode}`).classList.toggle('d-none', !isCurrent);
                document.getElementById(`single-${mode}-pane`).classList.toggle('d-none', !isCurrent);
            });
            document.getElementById('results-resistance').classList.toggle('d-none', newMode !== 'resistance');
            document.getElementById('results-voltage').classList.toggle('d-none', newMode === 'resistance');

            try {
                const response = await fetch(`LM393.svg`);
                if (!response.ok) throw new Error('Network response was not ok');
                schematicContainer.innerHTML = await response.text();
            } catch (error) {
                schematicContainer.innerHTML = `<p class="text-danger">Error loading schematic: ${error.message}</p><p>Please ensure <strong>LM393.svg</strong> is in the same folder.</p>`;
                return;
            }

            const sliderLabel = document.getElementById('slider_label');
            const VCC = parseFloat(document.getElementById('vcc').value);
            if (newMode === 'resistance') {
                sliderLabel.textContent = 'Sensor Resistance';
                simSlider.min = 0; simSlider.max = 10000; simSlider.step = 10; simSlider.value = 4000;
            } else if (newMode === 'voltage') {
                sliderLabel.textContent = 'Sensor Voltage';
                simSlider.min = 0; simSlider.max = VCC; simSlider.step = 0.01; simSlider.value = VCC / 2;
            } else {
                sliderLabel.textContent = 'Sensor Current';
                // Range for current slider is now set dynamically in calculate()
            }
            calculate();
        }

        function toggleHysteresisInputs() {
            const isEnabled = hysteresisToggle.checked;
            document.getElementById('hysteresis_inputs').classList.toggle('d-none', !isEnabled);
            document.getElementById('single_trip_inputs').classList.toggle('d-none', isEnabled);
            calculate();
        }

        tabs.forEach(tab => tab.addEventListener('shown.bs.tab', (event) => switchMode(event.target.id.split('-')[0])));
        allInputs.forEach(input => input.addEventListener('input', calculate));
        simSlider.addEventListener('input', simulate);
        hysteresisToggle.addEventListener('change', toggleHysteresisInputs);
        window.addEventListener('load', () => {
            switchMode('resistance');
            toggleHysteresisInputs();
        });

    </script>
</body>
</html>
